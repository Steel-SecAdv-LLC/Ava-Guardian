name: CI - Build and Test

on:
  push:
    branches: [ main, develop, 'claude/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # C Library Build and Test
  c-library:
    name: C Library (${{ matrix.os }}, ${{ matrix.compiler }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        compiler: [gcc, clang]
        include:
          - os: ubuntu-latest
            compiler: gcc
            cc: gcc-11
            cxx: g++-11
          - os: ubuntu-latest
            compiler: clang
            cc: clang-14
            cxx: clang++-14
          - os: macos-latest
            compiler: gcc
            cc: gcc-12
            cxx: g++-12
          - os: macos-latest
            compiler: clang
            cc: clang
            cxx: clang++

    steps:
      - uses: actions/checkout@v6

      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake libssl-dev ${{ matrix.cc }} ${{ matrix.cxx }}

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install cmake openssl gcc@12

      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          # Set compiler and OpenSSL path
          if [ "$RUNNER_OS" = "macOS" ]; then
            OPENSSL_ROOT=$(brew --prefix openssl)
            # For GCC on macOS, use full path
            if [ "${{ matrix.compiler }}" = "gcc" ]; then
              CC_PATH=$(brew --prefix gcc@12)/bin/gcc-12
              CXX_PATH=$(brew --prefix gcc@12)/bin/g++-12
            else
              CC_PATH=${{ matrix.cc }}
              CXX_PATH=${{ matrix.cxx }}
            fi
          else
            OPENSSL_ROOT=""
            CC_PATH=${{ matrix.cc }}
            CXX_PATH=${{ matrix.cxx }}
          fi

          cmake .. \
            -DCMAKE_C_COMPILER=${CC_PATH} \
            -DCMAKE_CXX_COMPILER=${CXX_PATH} \
            -DCMAKE_BUILD_TYPE=Release \
            -DAVA_BUILD_SHARED=ON \
            -DAVA_BUILD_STATIC=ON \
            -DAVA_BUILD_TESTS=ON \
            -DAVA_ENABLE_AVX2=OFF \
            ${OPENSSL_ROOT:+-DOPENSSL_ROOT_DIR=${OPENSSL_ROOT}}

      - name: Build
        run: cmake --build build --config Release -j4

      - name: Test
        run: cd build && ctest --output-on-failure

  # Python Package Build and Test
  python-package:
    name: Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install system dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3-dev cmake libssl-dev

      - name: Install system dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: brew install cmake openssl

      - name: Install Python build dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install Cython>=0.29.30 numpy>=1.21

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Build and install package (without C extensions on Windows)
        if: matrix.os == 'windows-latest'
        env:
          AVA_NO_C_EXTENSIONS: 1
        run: pip install -e .

      - name: Build and install package (with C extensions)
        if: matrix.os != 'windows-latest'
        run: pip install -e .

      - name: Run tests
        env:
          # UTF-8 encoding for Windows to support Unicode symbols (â™±) in output
          PYTHONIOENCODING: ${{ matrix.os == 'windows-latest' && 'utf-8' || '' }}
          PYTHONUTF8: ${{ matrix.os == 'windows-latest' && '1' || '' }}
        run: pytest tests/ -v --cov=ava_guardian --cov-report=xml

      - name: Upload coverage
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: python
          name: python-${{ matrix.python-version }}

  # Linting and Code Quality
  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install black flake8 mypy isort

      - name: Check formatting (black)
        run: black --check --diff ava_guardian/ tests/

      - name: Check import sorting (isort)
        run: isort --check-only --diff ava_guardian/ tests/

      - name: Lint (flake8)
        run: flake8 ava_guardian/ tests/ --max-line-length=100

      - name: Type check (mypy)
        run: mypy ava_guardian/ --ignore-missing-imports
        continue-on-error: true

  # Security Audit
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pip-audit bandit safety

      - name: Audit dependencies
        run: pip-audit
        continue-on-error: true

      - name: Security scan (bandit)
        run: bandit -r ava_guardian/ -ll
        continue-on-error: true

  # Docker Build
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Ubuntu image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile
          push: false
          load: true
          tags: ava-guardian:ubuntu
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Alpine image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.alpine
          push: false
          load: true
          tags: ava-guardian:alpine
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Ubuntu image
        run: |
          docker run --rm ava-guardian:ubuntu python3 -c "import ava_guardian; print('OK')"

      - name: Test Alpine image
        run: |
          docker run --rm ava-guardian:alpine python3 -c "import ava_guardian; print('OK')"
